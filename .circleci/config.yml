version: 2.1
jobs:
  build_and_test:
    docker:
      - image: cimg/base:stable-18.04
      - image: circleci/mysql:5.7
        environment:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_DATABASE: vagrant
      - image: circleci/postgres:10-alpine-postgis
      - image: circleci/openjdk:8u131-jdk
      - image: arafato/azurite
        environment:
          executable: blob
    steps:
      - checkout
      - run:
          name: Install maven
          command: sudo apt-get update && sudo apt-get install -y maven
      - run:
          name: Run unit tests
          command: |
            export JVM_ARGS="-Dnashorn.args=--no-deprecation-warning"
            mvn -X clean test
      - run:
          name: Generate code coverage
          command: |
            export JVM_ARGS="-Dnashorn.args=--no-deprecation-warning"
            mvn clean site -Dcobertura.report.format=xml org.eluder.coveralls:coveralls-maven-plugin:report
workflows:
  all:
    jobs:
      - build_and_test
