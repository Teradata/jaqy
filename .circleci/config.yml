version: 2.1
jobs:
  build_and_test:
    docker:
      - image: maven:3.6.0-jdk-8
        environment:
         TZ: "America/Los_Angeles"
      - image: circleci/mysql:5.7
        environment:
          MYSQL_ROOT_PASSWORD: ''
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_DATABASE: vagrant
      - image: circleci/postgres:10-alpine-postgis
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: ''
          TZ: 'GMT+2'
      - image: arafato/azurite
        environment:
          executable: blob
    steps:
      - checkout
      - run:
          name: Install hexdump
          command: apt-get update && apt-get install -y bsdmainutils
      - run:
          name: Maven Unit Tests
          command: mvn -X clean package
      - run:
          name: CLI Tests
          command: chmod +x tests/bin/*.sh && tests/bin/testall.sh
      - run:
          name: Generate code coverage
          command: mvn clean site -Dcobertura.report.format=xml
      - run:
          name: Upload
          command: bash <(curl -s https://codecov.io/bash)
workflows:
  all:
    jobs:
      - build_and_test
