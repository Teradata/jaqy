version: 2.1
orbs:
  maven: circleci/maven@1.2.0
jobs:
  build_and_test:
    docker:
      - image: cimg/base:stable-18.04
      - image: circleci/mysql:5.7
        auth:
          username: mydockerhub-user
          password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
        environment:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_DATABASE: vagrant
      - image: circleci/postgres:10-alpine-postgis
      - image: circleci/openjdk:8u131-jdk
    steps:
      - checkout
      - run:
          name: Setup mysql
          command: |
            mysql -e 'CREATE DATABASE IF NOT EXISTS vagrant;' -uroot
            mysql -e "GRANT ALL PRIVILEGES ON vagrant.* TO 'vagrant'@'localhost';" -uroot
      - run:
          name: azurite
          command: |
            sudo docker pull arafato/azurite
            sudo docker run -e executable=blob -d -t -p 10000:10000 -v /tmp/azurite:/opt/azurite/folder arafato/azurite
      - run:
          name: Build and test
          command: mvn clean test
      - run:
          name: Generate code coverage
          command: mvn clean site -Dcobertura.report.format=xml org.eluder.coveralls:coveralls-maven-plugin:report
workflows:
  all:
    jobs:
      - build_and_test
